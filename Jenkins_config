#!/usr/bin/env groovy
//properties generated by pipeline syntax
properties([
  [$class: 'JiraProjectProperty'], [$class: 'GitlabLogoProperty', repositoryName: ''], [$class: 'RebuildSettings', autoRebuild: false, rebuildDisabled: false],
  parameters([
    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: 'master', listSize: '8', name: 'git_branch', quickFilterEnabled: true, selectedValue: 'DEFAULT', sortMode: 'NONE', tagFilter: '*', type: 'PT_BRANCH'),
    booleanParam(defaultValue: false, description: "Upload Results in XRAY-JIRA", name: "need_results_in_jira"),
    choice(choices: ['fcs', 'accm', 'cosma'], description: 'Test collection', name: 'collection'),
    [$class: 'CascadeChoiceParameter', choiceType: 'PT_CHECKBOX', filterLength: 1, filterable: false, name: 'test_case', randomName: 'choice-parameter-46743950924697', referencedParameters: 'collection', script: [
      $class: 'GroovyScript', fallbackScript: [classpath: [], sandbox: true, script: ''], script: [
        classpath: [], sandbox: true, script: '''
          if(collection.equals("fcs")){
            return [
              "test_fcs_appium_install.py",
              "test_fcs_appium_login.py:selected",
              "test_fcs_appium_check_vk_login_single_phone.py",
              "test_fcs_appium_car_operations.py:selected",
              "test_fcs_appium_double_transfer.py",
              "test_fcs_appium_driver_list.py:selected",
              "test_fcs_appium_edit_vehicle.py:selected",
              "test_fcs_appium_manage_account.py:selected",
              "test_fcs_appium_transfer.py:selected",
              "test_fcs_guest_basic_tests.py:selected",
              "test_fcs_guest_push_notification_tests.py:selected",
              "test_fcs_push_notification.py:selected",
              "test_fcs_multi_dealership.py"
            ]
          }
          else if (collection.equals( "accm")){
            return [
              "test_accm_appium_car_operations.py",
              "test_accm_appium_login_single_phone.py",
              "test_accm_appium_uart_operations.py",
              "test_accm_customer_api.py",
              "test_accm_web_common_cases.py",
              "test_accm_web_privatemode.py",
              "test_accm_web_telemetry_remoteoperations.py",
              "test_accm_config_update.py",
              "test_accm_interoperability_test.py",
              "test_accm_appium_time_connection.py"
            ]
          }
          else if (collection.equals( "cosma")){
            return [
              "cosma_ios_basic_campaign.py",
              "test_cosma_extended.py",
              "test_cosma_main.py",
              "test_load_cosma.py",
              "cosma_manual_tests.py",
              "test_cosma_keycore_only.py",
              "test_customer_api.py",
              "test_request_time.py",
              "test_cosma_keycore_daily.py"
            ]
          }
          else{
            return ["Unknown state"]
            }
        ''']]
    ],
    [$class: 'CascadeChoiceParameter', choiceType: 'PT_SINGLE_SELECT', description: 'select the environment', filterLength: 1, filterable: false, name: 'test_environment', randomName: 'choice-parameter-27573015718003', referencedParameters: 'collection', script: [
      $class: 'GroovyScript', fallbackScript: [classpath: [], oldScript: '', sandbox: true, script: ''], script: [
        classpath: [], oldScript: '', sandbox: true, script: '''
          if(collection.equals("fcs")){
            return [
              "us_preprod",
              "cn_preprod"
            ]
          }
          else if (collection.equals( "accm")){
            return [
              "us_preprod",
              "us_keycore-dev",
              "us_sandbox",
              "debug2"
            ]
          }
          else if (collection.equals( "cosma")){
            return [
              "keycore_cosma",
              "us_keycore-dev"
            ]
          }
          else{
            return ["Unknown state"]
          }
        ''']]
    ],
    [$class: 'DynamicReferenceParameter', choiceType: 'ET_FORMATTED_HTML', name: 'appVersion', omitValueField: false, randomName: 'choice-parameter-46743952773074', referencedParameters: 'test_case', script: [
      $class: 'GroovyScript', fallbackScript: [classpath: [], sandbox: true, script: ''], script: [
        classpath: [], sandbox: true, script: '''
          if (test_case.contains("test_fcs_appium_install.py")){
            inputBox = "<input name=\\"value\\" class=\\"setting-input\\" type=\\"text\\">"
            return inputBox
          }
          else{
            return ["Only for app installation testsuite"]
          }
        ''']]
    ],
    [$class: 'DynamicReferenceParameter', choiceType: 'ET_FORMATTED_HTML', name: 'markers', omitValueField: false, randomName: 'choice-parameter-42384030372612', referencedParameters: 'collection', script: [
      $class: 'GroovyScript', fallbackScript: [classpath: [], sandbox: true, script: ''], script: [
        classpath: [], sandbox: true, script: '''
          if (collection.equals("cosma")){
            inputBox = "<input name=\\"value\\" class=\\"setting-input\\" type=\\"text\\">"
            return inputBox
          }
          else{
            return ["Markers for COSMA collection"]
          }
        ''']]
    ],
    [$class: 'DynamicReferenceParameter', choiceType: 'ET_FORMATTED_HTML', name: 'fota', omitValueField: false, randomName: 'choice-parameter-46743954559032', referencedParameters: 'test_case', script: [
      $class: 'GroovyScript', fallbackScript: [classpath: [], sandbox: true, script: ''], script: [
        classpath: [], sandbox: true, script: '''
          if (test_case.contains("test_accm_fota.py")){
            inputBox = "<input name=\\"value\\" class=\\"setting-input\\" type=\\"text\\">"
            return inputBox
          }
          else{
            return ["Only for FOTA testsuite"]
          }
        ''']]
    ]
  ])
])

pipeline {
  agent { label env.JOB_NAME-'KaaS/' }

  options {
    // Do not allow concurrent builds
    disableConcurrentBuilds()
    // Global period allowed for the pipeline to finish
    timeout(time: 4, unit: 'HOURS')
    // Enable color in console logs
    ansiColor('xterm')
    // Adds timestamps to the console output of Jenkins jobs
    timestamps()
  }// options

  environment {
    TEST_COLLECTION = "${params.collection}"
    TEST_ENVIRONMENT =  "${params.test_environment}"
    NEED_RESULTS_IN_JIRA = "${params.need_results_in_jira}"

  }//Environment

  stages {
    stage('Clone Test Bench') {
      steps {
        script {
          git branch: "${params.git_branch}",
          url: "git@code.tooling.prod.cdsf.io:kaas/qa/test_bench.git",
          credentialsId: 'gtp-gitlab-keycore-ssh-private-key'
        }// script
      }//steps
    }// stage update target
    stage('Run Pytest'){
      steps {
        script{
          tc = params.test_case.replace(","," ")
          if (tc.contains("test_fcs_appium_install.py")){
            nocomma_arg = params.appVersion.replace(",","")
            echo "App version selected : ${nocomma_arg}"
            arg = "--app_version ${nocomma_arg}"
          }
          else if (tc.contains("test_accm_fota.py")){
            nocomma_arg = params.fota.replace(",","")
            echo "FOTA version selected : ${nocomma_arg}"
            echo "Running test_cases: ${tc} "
            arg = "--fota_version ${nocomma_arg}"
          }
          else {
            arg = ""
          }
          sh "export TEST_ENVIRONMENT=${params.test_environment};export NEED_RESULTS_IN_JIRA=${params.need_results_in_jira};tox -vve pytest -- ${tc} ${arg}"
        }
      }// steps Run Pytest
    }//stage Run Pytest

  }//end of stages

  post {
    always
    {
      sh "tar -zcvf report.tar.gz rpi_bench/reports"
      archiveArtifacts "report.tar.gz"
      sh "cp report.tar.gz report.tar.gz_\$(date +%Y%m%d_%H%M%S)"
      sh "cp report.tar.gz_* d:/reports || true"
      sh "cp report.tar.gz_* z:/reports || true"
      sh "cp report.tar.gz_* ~/reports || true"
      sh "find d:/reports -type f -mtime +90 -delete || true"
      sh "find ~/reports -type f -mtime +90 -delete || true"
      archiveArtifacts "rpi_bench/reports/*.html"
      sh "adb kill-server"
      cleanWs()
    }
  }

} /*Pipeline*/
